function smoke_test_multinode()
cfg = cfg_default();

% Defaults per your request
U = 10; m = 64; B = 64;

% Create node population
%nodes = init_node_population(U, m, 'noise_sigma', 0.0, 'seed', 7);
nodes = init_node_population(U, m, 'seed', 7);


% Base challenge and nonce
C_seed = randi([0 1], 1, m);
nonce_bits = randi([0 1], 1, 32); % 32-bit nonce baseline

% Choose transmitting node
u0 = 3;

% Build logical OFDM symbol
[X, Xp, meta] = gen_ofdm_symbol(cfg);

% --- TX mapping from legit node u0
map_tx = verifier_mapping_apuf(nodes(u0), C_seed, nonce_bits, B, cfg.Npilots, cfg.K_active_pilots);

[Xtilde, templ_tx, st_tx] = apply_structure_operator_pilots(X, Xp, meta, map_tx.pilot_perm_local, map_tx.pilot_mask_local);

% OFDM modulate
x = ifft(Xtilde, cfg.Nfft);
x_cp = [x(end-cfg.Ncp+1:end); x];

% Channel + AWGN
cfg.chan.type = 'awgn';
[y_cp, H] = channel_model(cfg, x_cp);

SNRdB = 10;
sig_pow = mean(abs(y_cp).^2);
SNRlin = 10^(SNRdB/10);
noise_pow = sig_pow / SNRlin;
w = sqrt(noise_pow/2) * (randn(size(y_cp)) + 1j*randn(size(y_cp)));
r_cp = y_cp + w;

% Receiver: CP remove + FFT
r = r_cp(cfg.Ncp+1:end);
Y = fft(r, cfg.Nfft);

% Perfect equalization
Hhat = estimate_channel(cfg, H, [], [], meta.pilot_idx);
Z = Y ./ (Hhat + 1e-12);

% Test hypotheses across users
Tperm = zeros(1,U);
Tim   = zeros(1,U);

for u = 1:U
    map_rx = verifier_mapping_apuf(nodes(u), C_seed, nonce_bits, B, cfg.Npilots, cfg.K_active_pilots);
    [~, templ_rx, st_rx] = apply_structure_operator_pilots(X, Xp, meta, map_rx.pilot_perm_local, map_rx.pilot_mask_local);

    Tperm(u) = abs(metric_perm_correlator(Z, templ_rx));
    %Tim(u)   = metric_im_energysep_pilots(Z, meta.pilot_idx, st_rx.Atilde); % you have normalized version now
    tmp = metric_im_energysep_pilots(Z, meta.pilot_idx, st_rx.Atilde);
    Tim(u) = tmp.norm;    % or tmp.raw if you prefer
    disp(st_rx.Atilde.')
    Asets{u} = sort(st_rx.Atilde(:)).';
end

fprintf('TX node u0 = %d at SNR=%g dB\n', u0, SNRdB);
disp(table((1:U).', Tperm.', Tim.', 'VariableNames', {'User','Tperm_abs','Tim'}));

[~, best_perm] = max(Tperm);
[~, best_im]   = max(Tim);
fprintf('Best (perm) hypothesis user: %d\n', best_perm);
fprintf('Best (IM)   hypothesis user: %d\n', best_im);
end
